# 懒加载优化配置说明

## 优化后的加载策略

### 1. 列表页（首页、搜索、排行榜等）

**行为：**

- ✅ 只加载当前可见区域的图片
- ✅ 提前 50px 开始预加载（提供无缝体验）
- ✅ 滚动时自动加载进入视口的图片
- ✅ 不会一次性加载所有图片

**技术实现：**

- 使用 Intersection Observer API 监听图片可见性
- `rootMargin: '50px'` - 提前 50px 预加载
- 图片进入视口后自动加载

### 2. 漫画阅读器

#### 滚动模式

**优化策略：**

- ✅ 先快速加载前 3 页（50ms 间隔）
- ✅ 后续页面慢速加载（500ms 间隔）
- ✅ 避免一次性大量请求
- ✅ 显示加载进度条
- ✅ 切换模式时自动取消加载

**加载流程：**

```
第 1 页 → 等待 50ms → 第 2 页 → 等待 50ms → 第 3 页
      ↓
等待 500ms
      ↓
第 4 页 → 等待 500ms → 第 5 页 → 等待 500ms → ...
```

#### 翻页模式

**优化策略：**

- ✅ 预加载当前页 + 相邻页（共3页）
- ✅ 按优先级加载（当前页 > 下一页 > 上一页）
- ✅ 翻页时自动预加载新的相邻页

## 可配置参数

### 修改加载参数

编辑 `frontend/src/views/ReaderView.vue`，在文件开头找到 `LOADING_CONFIG`：

```javascript
// 图片加载配置
const LOADING_CONFIG = {
  priorityPages: 3, // 优先加载的页数（默认3页）
  priorityDelay: 50, // 优先页面加载间隔（毫秒，默认50ms）
  normalDelay: 500, // 普通页面加载间隔（毫秒，默认500ms）
  maxConcurrent: 2, // 最大并发数（默认2）
};
```

### 参数说明

| 参数            | 说明                   | 默认值 | 建议范围   |
| --------------- | ---------------------- | ------ | ---------- |
| `priorityPages` | 优先快速加载的页数     | 3      | 2-5        |
| `priorityDelay` | 优先页面之间的加载间隔 | 50ms   | 30-100ms   |
| `normalDelay`   | 普通页面之间的加载间隔 | 500ms  | 300-1000ms |
| `maxConcurrent` | 翻页模式最大并发加载数 | 2      | 1-5        |

### 调整建议

**网络较快时：**

```javascript
const LOADING_CONFIG = {
  priorityPages: 5, // 增加优先页数
  priorityDelay: 30, // 减少延迟
  normalDelay: 300, // 减少延迟
  maxConcurrent: 3, // 增加并发
};
```

**网络较慢或服务器压力大时：**

```javascript
const LOADING_CONFIG = {
  priorityPages: 2, // 减少优先页数
  priorityDelay: 100, // 增加延迟
  normalDelay: 1000, // 增加延迟
  maxConcurrent: 3, // 减少并发
};
```

**立即加载所有图片（不推荐）：**

```javascript
const LOADING_CONFIG = {
  priorityPages: 999, // 设置为超大值
  priorityDelay: 0, // 零延迟
  normalDelay: 0, // 零延迟
  maxConcurrent: 10, // 高并发
};
```

### 修改列表页预加载距离

编辑 `frontend/src/components/LazyImage.vue`，找到 `setupObserver` 函数：

```javascript
// 当前设置：提前 50px
const rootMargin = props.sequential ? "0px" : "50px";

// 修改为提前 100px
const rootMargin = props.sequential ? "0px" : "100px";

// 修改为提前 200px
const rootMargin = props.sequential ? "0px" : "200px";
```

## 性能对比

### 优化前

- ❌ 进入阅读器后立即请求所有图片
- ❌ 可能造成服务器过载（几十个并发请求）
- ❌ 初始加载时间长
- ❌ 浪费带宽（用户可能不看完）

### 优化后

- ✅ 先加载前3页（用户马上能看）
- ✅ 后续页面慢速加载（控制并发）
- ✅ 初始加载时间短（只加载3张）
- ✅ 节省带宽（按需加载）
- ✅ 服务器压力小（最多2-3个并发）

## 用户体验优化

### 加载进度条

在滚动模式下，顶部会显示蓝色进度条，实时显示加载进度：

```
[████████████░░░░░░░░] 60%
```

### 加载状态

每张图片都有清晰的加载状态：

1. **占位符**：灰色背景 + 闪烁动画
2. **加载中**：显示旋转加载图标
3. **加载完成**：平滑淡入效果
4. **加载失败**：显示错误图标，点击可重试

### 智能取消

- 切换到翻页模式时，自动停止滚动模式的顺序加载
- 切换回滚动模式时，从当前位置继续加载
- 离开页面时，自动清理所有加载任务

## 测试加载效果

### 1. 测试滚动模式

```bash
# 启动开发服务器
cd frontend && npm run dev
```

1. 打开浏览器开发者工具 (F12)
2. 切换到 Network 标签
3. 启用网络节流：Throttling → Slow 3G
4. 进入漫画阅读器（滚动模式）
5. 观察：
   - 前3张图片快速加载（50ms间隔）
   - 顶部出现蓝色进度条
   - 后续图片慢速加载（500ms间隔）
   - Network 标签显示请求间隔

### 2. 测试列表页

1. 打开首页
2. 观察 Network 标签
3. 只有可见区域的封面在加载
4. 滚动页面时，新的封面才开始加载

### 3. 测试翻页模式

1. 切换到翻页模式
2. 观察 Network 标签
3. 只加载3张图片（当前页 + 相邻页）
4. 翻页时加载新的相邻页

## 故障排查

### 问题：图片加载太慢

**原因：**延迟时间设置过大

**解决：**减少 `normalDelay` 的值

```javascript
normalDelay: 300,  // 从 500 改为 300
```

### 问题：服务器压力太大

**原因：**并发数或加载速度过高

**解决：**

1. 减少并发数
2. 增加延迟时间
3. 减少优先页数

```javascript
priorityPages: 2,
normalDelay: 1000,
maxConcurrent: 1,
```

### 问题：第一页加载很慢

**原因：**需要等待章节信息API返回

**解决：**这是正常现象，因为必须先获取图片列表。可以在详情页预加载第一张图片。

### 问题：切换模式后图片不显示

**原因：**可能是组件缓存问题

**解决：**刷新页面，或检查浏览器控制台是否有错误。

## 监控和调试

### 查看加载进度

打开浏览器控制台，输入：

```javascript
// 查看滚动模式加载进度
console.log("加载进度:", document.querySelector(".progress-fill")?.style.width);
```

### 查看 Network 时序

1. 开发者工具 → Network
2. 按住 Shift 刷新页面（清除缓存）
3. 观察请求的 Waterfall（瀑布图）
4. 可以看到请求之间的间隔

## 最佳实践

1. **服务器性能一般**：保持默认配置（3页优先，500ms延迟）
2. **服务器性能好**：增加优先页数到5，减少延迟到300ms
3. **移动设备**：减少并发数到1，增加延迟
4. **Wi-Fi环境**：可以适当提高并发和减少延迟
5. **流量计费用户**：增加延迟，让用户有时间停止浏览

## 总结

通过优化后的懒加载策略：

✅ **列表页**：只加载可见区域，滚动时按需加载
✅ **阅读器**：前3页快速加载，后续慢速加载
✅ **避免服务器过载**：控制并发数和加载速度
✅ **改善用户体验**：进度条、加载状态、平滑动画
✅ **可配置**：所有参数都可以根据需求调整

这样既保证了用户体验，又避免了服务器压力和带宽浪费。
